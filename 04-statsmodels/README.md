# Статистический и регрессионный анализ с Statsmodels

## Введение

Библиотека [`statsmodels`](https://www.statsmodels.org/) является одной базовых для статистического и эконометрического анализа.
Она включает ([ссылка](https://www.statsmodels.org/stable/user-guide.html))

- Регрессионные и линейные модели (основное):
	- линейная регрессия (количественная зависимая переменная)
	- обобщённая линейная модель
	- регрессия с дискретной зависимой переменной (logit/probit и др)
	- робастная линейная регрессия (квант ильная и др)
	- другие модели (ANOVA и др.)
- Анализ временных рядов (основное):
	- ARMA/ARIMA
	- экспоненциальное сглаживание
	- ARDL
	- VAR, VECM, VARMA
	- модели пространства состояний
	- модели с переключателем
	- фильтрация (в том числе, на сезонность)
	- тесты для временных рядов: единичного корня и др
- Статистические инструменты (основные):
	- эмпирическая cdf
	- построение графиков
	- тестирование гипотез
	- вывод и оформление результатов подгонки моделей
	- вспомогательные функции

Импорт библиотеки

- `import statsmodels.api as sm`: регрессии, спецификация через матрицы регрессионного дизайна
- `statsmodels.formula.api as smf`: регрессии, спецификация через формулу
- `import statsmodels.tsa.api as tsa`: модели временных рядов

## Работа с моделями из Statsmodels

Алгоритм
* Инициализация модели (спецификация)
* подгонка под наблюдения (оценка) с необходимыми параметрами, метод `.fit(...)`
* работа с подогнанной моделью
	- вывод протокола подгонки
	- значимость/интерпретация коэффициентов, R2
	- тестирование гипотез о коэффициентах
	- диагностика
	- другое

## Инициализация/спецификация модели

Два альтернативных способа 
- через формулу
- через матрицы регрессионного дизайна `y, X`

### спецификация через формулу

Формула записывается как строка по правилу 
- `endog~1+exog1+exog2+...` или `enog~exog1+exog2+...` для регрессии с константой
- `endog~0+exog1+exog2+...` для регрессии без константы

**Важное замечание**
- пропущенные наблюдения будут удалены автоматически
- категориальные регрессоры автоматические преобразуется в пул дамми-переменных и они включаются в модель
- преобразование переменных ('на лету')

|Преобразование|Интерфейс|
|-|-|
|квадрат регрессора|`I(exog**2)`|
|логарифм переменной|`np.log(...)`|
||(используем функцию пакета `numpy`)|
|масштабирование|`I(exog*c)`|
|(умножить/разделить на число `c`)|`I(exog/c)`|
|умножение переменных|`I(exog1*exog2)` или `exog1:exog2`|

### Матрицы регрессионного дизайна

- `y`: вектор наблюдений зависимой переменной
- `X`: матрица (таблица) наблюдений регрессоров

**Важное замечание**: 
- контролируем наличие пропущенных наблюдений
- если в регрессию включена константа, то первым столбцом матрицы `X` должен столбец только из единиц. Добавить такой столбце можно методом `.add_constant()`. Импортировать его можно так `from statsmodels.api import add_constant`
- все преобразования переменных нужно делать вручную
 

## Линейная регрессия в statsmodels (класс OLS & RegressionResults)

### Инициализация модели
*спецификация через формулу* `smf.ols(formula, data)` или `sm.OLS.form_formula(formula, data)`

*спецификация через матрицы регрессионного дизайна*: `sm.OLS(endog, exog, missing='none')`

Здесь параметр `missing` позволяет контролировать что делать с пропущенными наблюдениями. Возможные значения `none, drop, raise`.

В результате создаётся объект класса [`OLS`](https://www.statsmodels.org/stable/generated/statsmodels.regression.linear_model.OLS.html#statsmodels.regression.linear_model.OLS).

### Подгонка модели

Для объекта `OLS` используем метод `.fit(cov_type='nonrobust')`

В результате создаётся объект класса [`RegressionResults`](https://www.statsmodels.org/stable/generated/statsmodels.regression.linear_model.RegressionResults.html#statsmodels.regression.linear_model.RegressionResults) (результат подгонки модели).

Параметр `cov_type` задаёт тип оценки ковариационной матрицы для коэффициентов

|`cov_type`|Тип оценки|
|-|-|
|`nonrobust`|неробастная OLS|
|`HC0`|робастная White|
|`HC1`|робастная к гетероскедастичости|
|`HC2`|робастная к гетероскедастичости|
|`HC3`|робастная к гетероскедастичости|
|`HAC`|робастная Newey-West|

### Вывод результатов подгонки

Общий протокол подгонки модели регрессии выводится методом [summary](https://www.statsmodels.org/stable/generated/statsmodels.regression.linear_model.RegressionResults.summary.html#statsmodels.regression.linear_model.RegressionResults.summary) `.summary(yname=None, xname=None, title=None, alpha=0.05, slim=False)`

Здесь `slim` показывает выводить ли полный или сокращенный протокол подгонки

Протокол можно сохранить в виде файла использую методы `.as_csv()`, `.as_latex()`, `.as_html()`, `.as_text()`