# Регрессионный анализ с Linearmodels

## Введение

Библиотека [`linearmodels`](https://bashtage.github.io/linearmodels/index.html) дополняет `statsmodels`.
Она включает 

- Регрессии панельных данных
	- Pooling-модель
	- RE-модель
	- FE-модель (Within, FD, Between-оценки)
- IV-оценки
- GMM-оценки

Импорт библиотеки ([основные модели панельных данных](https://bashtage.github.io/linearmodels/panel/index.html))

- `from linearmodels import PooledOLS`: pooling регрессия
- `from linearmodels import RandomEffects`: RE-регрессия
- `from linearmodels import PanelOLS`: FE-регрессия

## Панельные данные в pandas

Задать панельную структуру для объекта `pandas.DataFrame` можно с помощью мультииндекса (**важен порядок!!!**)

`pandas.DataFrame.set_index(['id', 'time'], drop=True)`

здесь
- `id` – индивидуальный индекс (имя д.б. как в датафрейме)
- `time` – временной индекс (имя д.б. как в датафрейме)
- `drop`: удалить ли индексные переменные из датафрейма

В результате создаётся новый датафрейм с панельной структурой 

Преобразования панельных данных (для переменных `vars` в виде списка):
- лаг по времени `DataFrame.groupby(level=0)[vars].shift()`
- дифференцирование/первая разность по времени `DataFrame.groupby(level=0)[vars].diff()`

**Важное замечание** при этих преобразованиях теряется одно наблюдение

## Работа с моделями из Linearmodels

Алгоритм
* инициализация модели (спецификация)
* подгонка под наблюдения (оценка) с необходимыми параметрами, метод `.fit(...)`
* работа с подогнанной моделью
	- вывод протокола подгонки
	- значимость/интерпретация коэффициентов, R2
	- тестирование гипотез о коэффициентах
	- диагностика
	- другое

### Инициализация/спецификация модели

Два альтернативных способа 
- через формулу
- через матрицы регрессионного дизайна `y, X`

**Важное замечание** Если в модель хотим включать лаги или первые разности (по времени) переменных, то
соответствующую переменную сначала нужно "вручную" добавить в датафрейм, а затем включить в модель (как зависимую или объясняющую)

### Спецификация через формулу

Формула записывается как строка по правилу 
- `endog~1+exog1+exog2+...` для регрессии с константой
- `endog~exog1+exog2+...` для регрессии без константы

**Важное замечание**
- Обязательно включаем `1` для константы (в отличие от `statsmodels`)
- Для FE-модели в формулу обязательно включаем `+EntityEffects` (для индивидуальных эффектов) и/или `+TimeEffects` (для временных эффектов)
- пропущенные наблюдения будут удалены автоматически
- категориальные регрессоры автоматические преобразуются в пул dummy-переменных и они включаются в модель
- преобразование переменных ('на лету')

|Преобразование|Интерфейс|
|-|-|
|квадрат регрессора|`I(exog**2)`|
|логарифм переменной|`np.log(...)` (используем функцию пакета `numpy`)|
|масштабирование (умножить/разделить на число `c`)|`I(exog*c)`, `I(exog/c)`|
|умножение переменных|`I(exog1*exog2)` или `exog1:exog2`|

### Матрицы регрессионного дизайна

- `y`: вектор наблюдений зависимой переменной
- `X`: матрица (таблица) наблюдений регрессоров

**Важное замечание**: 
- контролируем наличие пропущенных наблюдений
- если в регрессию включена константа, то первым столбцом матрицы `X` должен столбец только из единиц. Добавить такой столбце можно методом `.add_constant()`. Импортировать его можно так `from statsmodels.api import add_constant`
- все преобразования переменных нужно делать вручную


## Панельная регрессия в linearmodels

### Инициализация модели
*спецификация через формулу* 
- `PooledOLS.form_formula(formula, data)`
- `RandomEffects.form_formula(formula, data)`
- `PanelOLS.form_formula(formula, data, drop_absorbed=True)`

*спецификация через матрицы регрессионного дизайна*: 
- `PooledOLS(dependent, exog)`
- `RandomEffects(dependent, exog)`
- `PanelOLS(dependent, exog, entity_effects=False, time_effects=False, drop_absorbed=True)`

В результате создаётся объект соответствующего класса

**Важное замечание для FE-модели**: 
- используем `entity_effects` и `time_effects` чтобы задать индивидуальный и/или временные эффекты
- используем `drop_absorbed` чтобы удалить переменные, постоянные во времени

### Подгонка модели

Для объекта используем метод `.fit(cov_type='unadjusted')`

В результате создаётся объект класса (результат подгонки модели).

Параметр `cov_type` задаёт тип оценки ковариационной матрицы для коэффициентов (выбор зависит от условий на идеосинкратическую ошибку)

|`cov_type`|Тип оценки|
|-|-|
|`unadjusted`, `homoskedastic`|неробастная OLS|
|`robust`, `heteroskedastic`|робастная (только) к гетероскедастичости|
|`clustered`|робастная к гетероскедастичости и серийной или кросс корреляции|
||дополнительные параметры (boolean)|
||`cluster_entity`, `cluster_time`|
|`kernel`|робастная к гетероскедастичости, серийной и кросс корреляции|

### Вывод результатов подгонки

#### Для одной модели

Общий протокол подгонки одной модели регрессии выводится методом `.summary`

Протокол можно сохранить в виде файла использую методы `.as_csv()`, `.as_latex()`, `.as_html()`, `.as_text()`

#### Для нескольких моделей

Используем метод `compare(results, precision='tstats', stars=False)` ([ссылка](https://bashtage.github.io/linearmodels/panel/panel/linearmodels.panel.results.compare.html#linearmodels.panel.results.compare))

Параметры:
- `results`: список или словарь из подогнанных моделей
- `precision`: что будет выводиться в скобках под коэффициентами (альтернативно `std-errors`, `std_errors`)
- `stars`: коды значимости

Его можно импортировать так `from linearmodels.panel import compare`.

Таблицу с регрессиями модно сохранить в виде файла использую методы `.summary.as_csv()`, `.summary.as_latex()`, `.summary.as_html()`, `.summary.as_text()`

### Тестирование гипотез

Основные методы класса `RegressionResults`

|Метод|Тест|
|-|-|
|`.conf_int()`|Доверительные интервалы|
|`.wald_test()`|Тест Вальда на линейные ограничения (аналогичен F-тесту)|

## Разное для (подогнанной) регрессии

|Метод/Свойства|Описание|
|-|-|
|`.params`|коэффициенты модели|
|`.nobs`|Число наблюдений|
|`.df_model`|число регрессоров|
|`.df_resid`|nobs-df_model-1|
|`.rsquared`|R2|
|`.rsquared_between`|between R2|
|`.rsquared_overall`|overall R2|
|`.rsquared_within`|within R2|
|`.aic`|Информационный критерий Akaike|
|`.bic`|Байесовский информационный критерий|
|`.std_errors`|Стандартные ошибки коэффициентов|
|`.tstats`|t-статистики для коэффициентов|
|`.pvalues`|P-значения для значимости коэффициентов|
|`.f_statistic`|F-статистика на значимость регрессии|
|`.f_statistic_robust`|робастная F-статистика на значимость регрессии|
|`.resid`|остатки|
|`.fitted_values`|предсказанные значения|
|`.predict()`|Прогноз|
